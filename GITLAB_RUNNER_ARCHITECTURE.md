# GitLab Runner å®¹å™¨æ¶æ„è¯¦è§£

## æ¦‚è¿°

GitLab Runner åœ¨ Kubernetes ç¯å¢ƒä¸­è¿è¡Œæ—¶ï¼Œæ¶‰åŠ**å››ç±»å®¹å™¨**çš„ååŒå·¥ä½œã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å„å®¹å™¨çš„åŠŸèƒ½ã€è¿è¡Œæ—¶æœºåŠäº¤äº’æ–¹å¼ã€‚

---

## ä¸€ã€å››ç±»å®¹å™¨è¯¦è§£

### 1. Runner Manager Podï¼ˆç®¡ç†å™¨å®¹å™¨ï¼‰

**é•œåƒ**: `gitlab/gitlab-runner:v18.3.0`

**åŠŸèƒ½**:
- æŒç»­è¿è¡Œçš„å¸¸é©»è¿›ç¨‹
- å‘ GitLab Server æ³¨å†Œå¹¶è½®è¯¢è·å– CI/CD ä»»åŠ¡
- æ¥æ”¶åˆ°ä»»åŠ¡åï¼Œåœ¨ Kubernetes ä¸­åˆ›å»º Job Pod
- ç›‘æ§ Job Pod çš„æ‰§è¡ŒçŠ¶æ€
- æ”¶é›†ä»»åŠ¡æ—¥å¿—å¹¶ä¸ŠæŠ¥ç»™ GitLab Server
- ç®¡ç† Runner çš„ç”Ÿå‘½å‘¨æœŸ

**è¿è¡Œæ—¶æœº**:
- Helm å®‰è£…åæŒç»­è¿è¡Œ
- é…ç½®ä¸º Deploymentï¼Œå‰¯æœ¬æ•°å¯é…ç½®ï¼ˆæœ¬ä¾‹ä¸º 3 ä¸ªå‰¯æœ¬ï¼‰

**ç½‘ç»œé…ç½®**:
- ä½¿ç”¨ Kubernetes é»˜è®¤ DNS (kube-dns)
- éœ€è¦è®¿é—® GitLab Server (`http://gitlab.example.com/`)
- ç›‘å¬ Prometheus metrics ç«¯å£ (9252)

**å…³é”®é…ç½®** (`gitlab-runner-values.yaml`):
```yaml
image:
  registry: registry.example.com
  image: gitlab/gitlab-runner
  tag: v18.3.0

replicas: 3  # 3 ä¸ª Manager å‰¯æœ¬

concurrent: 10  # æ¯ä¸ª Manager æœ€å¤šå¹¶å‘ 10 ä¸ª job
```

---

### 2. Helper Containerï¼ˆè¾…åŠ©å®¹å™¨ï¼‰

**é•œåƒ**: `gitlab-runner-helper:x86_64-v18.3.0`

**åŠŸèƒ½**:
- å…‹éš† Git ä»“åº“ä»£ç åˆ°å…±äº« Volume
- ä» GitLab Server ä¸‹è½½ artifactsï¼ˆæ„å»ºäº§ç‰©ï¼‰
- æ‰§è¡Œ Job å®Œæˆåï¼Œä¸Šä¼  artifactsã€cacheã€test reports åˆ° GitLab
- å¤„ç† Git LFSã€å­æ¨¡å—ç­‰å¤æ‚ Git æ“ä½œ
- åœ¨ Job çš„ initã€pre-scriptã€post-script é˜¶æ®µè¿è¡Œ

**è¿è¡Œæ—¶æœº**:
- Job Pod å¯åŠ¨æ—¶ä½œä¸º **init container** å…ˆè¿è¡Œ
- å…‹éš†ä»£ç åè¿›å…¥ç­‰å¾…çŠ¶æ€
- Job æ‰§è¡Œå®Œæˆåï¼Œå†æ¬¡æ¿€æ´»ä¸Šä¼ äº§ç‰©

**ç½‘ç»œé…ç½®**:
- ç»§æ‰¿ Job Pod çš„ DNS é…ç½®
- éœ€è¦è®¿é—® GitLab Server (æ‹‰å–ä»£ç ã€ä¸Šä¼ äº§ç‰©)
- éœ€è¦è®¿é—®é…ç½®çš„é•œåƒä»“åº“ (æ‹‰å– helper é•œåƒæœ¬èº«)

**å…³é”®é…ç½®**:
```yaml
helper_image = "registry.example.com/gitlab/gitlab-runner-helper:x86_64-v18.3.0"
helper_cpu_limit = "500m"
helper_memory_limit = "512Mi"
```

**æ–‡ä»¶å…±äº«**:
- é€šè¿‡ Kubernetes emptyDir Volume ä¸ Build Container å…±äº« `/builds` ç›®å½•
- ä»£ç å…‹éš†åˆ° `/builds/<namespace>/<project>` è·¯å¾„

---

### 3. Build Containerï¼ˆæ„å»ºå®¹å™¨ï¼‰

**é•œåƒ**: åœ¨ `.gitlab-ci.yml` ä¸­é€šè¿‡ `image` å­—æ®µæŒ‡å®š

**ç¤ºä¾‹**:
```yaml
# build-job ä½¿ç”¨çš„é•œåƒ
image: registry.example.com/docker:latest

# deploy-job ä½¿ç”¨çš„é•œåƒ
image: registry.example.com/bitnami/kubectl:latest
```

**åŠŸèƒ½**:
- æ‰§è¡Œ CI/CD è„šæœ¬ï¼ˆbefore_scriptã€scriptã€after_scriptï¼‰
- è¿è¡Œæ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²å‘½ä»¤
- è®¿é—® Service Containerï¼ˆå¦‚ DinDã€æ•°æ®åº“ç­‰ï¼‰
- å·¥ä½œç›®å½•é»˜è®¤ä¸º `/builds/<namespace>/<project>`

**è¿è¡Œæ—¶æœº**:
- Helper Container å…‹éš†ä»£ç å®Œæˆåå¯åŠ¨
- æ‰§è¡Œå®Œæ‰€æœ‰è„šæœ¬åé€€å‡º

**ç½‘ç»œé…ç½®**:
- ç»§æ‰¿ Job Pod çš„ DNS é…ç½®ï¼ˆ**æœ¬ä¾‹é…ç½®ä¸ºèŠ‚ç‚¹å†…ç½‘ DNS**ï¼‰
- ä¸ Service Container å…±äº« Pod ç½‘ç»œå‘½åç©ºé—´
- é€šè¿‡ Service alias è®¿é—®æœåŠ¡ï¼ˆå¦‚ `tcp://docker:2375`ï¼‰

**å…³é”®é…ç½®**:
```yaml
# èµ„æºé™åˆ¶
cpu_limit = "2"
memory_limit = "2Gi"

# é•œåƒæ‹‰å–ç­–ç•¥
pull_policy = ["if-not-present"]
```

---

### 4. Service Containerï¼ˆæœåŠ¡å®¹å™¨ï¼‰

**é•œåƒ**: åœ¨ `.gitlab-ci.yml` ä¸­é€šè¿‡ `services` å­—æ®µæŒ‡å®š

**æœ¬ä¾‹ä½¿ç”¨**: Docker-in-Docker (DinD)
```yaml
services:
  - name: registry.example.com/docker:dind
    alias: docker  # å…³é”®ï¼šå®šä¹‰æœåŠ¡çš„ç½‘ç»œåˆ«å
    command:
      - "--tls=false"
      - "--insecure-registry=private-registry.example.com"
```

#### 4.1 åŸºæœ¬åŠŸèƒ½

**æ ¸å¿ƒèŒè´£**:
- æä¾›åå°æœåŠ¡ä¾› Build Container ä½¿ç”¨
- **DinD åœºæ™¯**: è¿è¡Œå®Œæ•´çš„ Docker å®ˆæŠ¤è¿›ç¨‹ (dockerd)
- å…¶ä»–å¸¸è§åœºæ™¯ï¼š
  - æ•°æ®åº“æœåŠ¡ï¼ˆMySQLã€PostgreSQLï¼‰
  - ç¼“å­˜æœåŠ¡ï¼ˆRedisã€Memcachedï¼‰
  - æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQã€Kafkaï¼‰
  - UI æµ‹è¯•ï¼ˆSeleniumã€Chrome Headlessï¼‰

#### 4.2 ç”Ÿå‘½å‘¨æœŸè¯¦è§£

**å®Œæ•´æ—¶é—´çº¿**ï¼ˆä»¥ DinD ä¸ºä¾‹ï¼‰:

```
T+0s    â”‚ Job Pod åˆ›å»ºå®Œæˆ
        â”‚ Kubernetes è°ƒåº¦å™¨é€‰æ‹©èŠ‚ç‚¹
        â”‚
T+1s    â”‚ ========== é˜¶æ®µ 1: å®¹å™¨å¯åŠ¨ ==========
        â”‚
        â”‚ Helper Container (init) å¯åŠ¨
        â”‚ â””â”€â”€ å…‹éš†ä»£ç  (2s)
        â”‚
T+3s    â”‚ Helper å®Œæˆï¼Œè¿›å…¥ Waiting çŠ¶æ€
        â”‚
        â”‚ ========== é˜¶æ®µ 2: Service å®¹å™¨å¯åŠ¨ ==========
        â”‚
T+4s    â”‚ Service Container (DinD) å¯åŠ¨
        â”‚ â””â”€â”€ æ‰§è¡Œ ENTRYPOINT: dockerd-entrypoint.sh
        â”‚     â”œâ”€â”€ åˆå§‹åŒ– Docker å­˜å‚¨é©±åŠ¨ (overlay2)
        â”‚     â”œâ”€â”€ è®¾ç½® iptables è§„åˆ™
        â”‚     â”œâ”€â”€ å¯åŠ¨ containerd
        â”‚     â””â”€â”€ å¯åŠ¨ dockerd å®ˆæŠ¤è¿›ç¨‹
        â”‚
T+5s    â”‚ dockerd å¯åŠ¨ä¸­...
        â”‚ æ—¥å¿—è¾“å‡º:
        â”‚   time="..." level=info msg="Starting up"
        â”‚   time="..." level=info msg="containerd not running, starting managed containerd"
        â”‚
T+7s    â”‚ dockerd ç›‘å¬ç«¯å£
        â”‚ æ—¥å¿—è¾“å‡º:
        â”‚   time="..." level=info msg="API listen on /var/run/docker.sock"
        â”‚   time="..." level=info msg="API listen on [::]:2375"
        â”‚
T+8s    â”‚ ========== é˜¶æ®µ 3: DinD å°±ç»ª ==========
        â”‚
        â”‚ DinD å®Œå…¨å°±ç»ªï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
        â”‚ çŠ¶æ€æ ‡è®°: Ready = true
        â”‚
        â”‚ Build Container å¯åŠ¨
        â”‚ â””â”€â”€ æ‰§è¡Œ before_script
        â”‚
T+9s    â”‚ ========== é˜¶æ®µ 4: æ¥æ”¶ç¬¬ä¸€ä¸ªè¯·æ±‚ ==========
        â”‚
        â”‚ Build Container æ‰§è¡Œ: docker info
        â”‚
        â”‚ ç½‘ç»œæµå‘:
        â”‚   Build Container (docker å‘½ä»¤)
        â”‚       â†“ TCP è¿æ¥
        â”‚   tcp://docker:2375
        â”‚       â†“ è§£æ alias
        â”‚   127.0.0.1:2375
        â”‚       â†“ æœ¬åœ°å›ç¯
        â”‚   DinD Container (dockerd è¿›ç¨‹)
        â”‚
        â”‚ DinD æ—¥å¿—:
        â”‚   time="..." level=debug msg="Calling GET /v1.xx/info"
        â”‚
        â”‚ è¿”å›ç»“æœ â†’ Build Container
        â”‚   Server Version: 27.1.1
        â”‚   Storage Driver: vfs
        â”‚   âœ… è¿æ¥æˆåŠŸç¡®è®¤
        â”‚
T+10s   â”‚ ========== é˜¶æ®µ 5: æ‰§è¡Œæ„å»ºä»»åŠ¡ ==========
        â”‚
        â”‚ Build Container æ‰§è¡Œ: docker build -t myapp .
        â”‚
        â”‚ ã€è¯·æ±‚æµç¨‹ã€‘
        â”‚   â‘  Build: å‘é€æ„å»ºä¸Šä¸‹æ–‡ (tar åŒ…)
        â”‚      â†“
        â”‚   â‘¡ DinD: æ¥æ”¶ä¸Šä¸‹æ–‡ï¼Œè§£å‹åˆ°ä¸´æ—¶ç›®å½•
        â”‚      æ—¥å¿—: Building context from tarball
        â”‚      â†“
        â”‚   â‘¢ DinD: è¯»å– Dockerfile
        â”‚      è§£æ: FROM python:3.9-slim
        â”‚      â†“
        â”‚   â‘£ DinD: æ£€æŸ¥æœ¬åœ°é•œåƒç¼“å­˜
        â”‚      ç»“æœ: æœªæ‰¾åˆ°
        â”‚      â†“
        â”‚   â‘¤ DinD: DNS è§£æé•œåƒä»“åº“
        â”‚      æŸ¥è¯¢: /etc/resolv.conf
        â”‚      nameserver: 10.0.0.2
        â”‚      åŸŸå: registry.example.com
        â”‚      ç»“æœ: 203.0.113.10
        â”‚      â†“
        â”‚   â‘¥ DinD: å»ºç«‹ HTTPS è¿æ¥
        â”‚      è¿æ¥: 203.0.113.10:443
        â”‚      â†“
        â”‚   â‘¦ DinD: æ‹‰å–é•œåƒå±‚
        â”‚      æ—¥å¿—:
        â”‚        Pulling from library/python
        â”‚        Layer 1: Downloading [=>  ] 5MB/50MB
        â”‚        Layer 2: Downloading [===>] 15MB/30MB
        â”‚      (35s ä¸‹è½½å®Œæˆ)
        â”‚      â†“
        â”‚   â‘§ DinD: æ‰§è¡Œ Dockerfile æŒ‡ä»¤
        â”‚      COPY . . â†’ å¤åˆ¶ä»£ç åˆ°é•œåƒ
        â”‚      RUN pip install â†’ æ‰§è¡Œå®‰è£…å‘½ä»¤
        â”‚      â†“
        â”‚   â‘¨ DinD: åˆ›å»ºæ–°é•œåƒ
        â”‚      Image ID: sha256:abc123...
        â”‚      Tag: myapp:latest
        â”‚      â†“
        â”‚   â‘© DinD: è¿”å›æ„å»ºç»“æœ
        â”‚      â†“
        â”‚   Build Container: æ¥æ”¶æˆåŠŸæ¶ˆæ¯
        â”‚      Successfully built abc123...
        â”‚      Successfully tagged myapp:latest
        â”‚
T+120s  â”‚ ========== é˜¶æ®µ 6: æ¨é€é•œåƒ ==========
        â”‚
        â”‚ Build Container æ‰§è¡Œ: docker push myapp:latest
        â”‚
        â”‚ ã€æ¨é€æµç¨‹ã€‘
        â”‚   â‘  Build: å‘é€ push è¯·æ±‚
        â”‚      â†“
        â”‚   â‘¡ DinD: è¯»å–é•œåƒå±‚
        â”‚      æ£€æŸ¥å“ªäº›å±‚å·²å­˜åœ¨äºè¿œç¨‹ä»“åº“
        â”‚      â†“
        â”‚   â‘¢ DinD: è¿æ¥ç›®æ ‡é•œåƒä»“åº“
        â”‚      åœ°å€: private-registry.example.com
        â”‚      è®¤è¯: ä½¿ç”¨ docker login å‡­è¯
        â”‚      â†“
        â”‚   â‘£ DinD: ä¸Šä¼ é•œåƒå±‚
        â”‚      æ—¥å¿—:
        â”‚        Layer 1: Pushed (already exists)
        â”‚        Layer 2: Pushed (already exists)
        â”‚        Layer 3: Pushing [=>  ] 10MB/50MB
        â”‚      â†“
        â”‚   â‘¤ DinD: æ¨é€ manifest
        â”‚      Tag: 56cc4792-86
        â”‚      â†“
        â”‚   â‘¥ DinD: è¿”å›æˆåŠŸ
        â”‚      â†“
        â”‚   Build Container: æ¥æ”¶æˆåŠŸæ¶ˆæ¯
        â”‚      56cc4792-86: digest: sha256:def456... size: 1234
        â”‚
T+160s  â”‚ ========== é˜¶æ®µ 7: Build è„šæœ¬å®Œæˆ ==========
        â”‚
        â”‚ Build Container æ‰§è¡Œå®Œ script
        â”‚ å®¹å™¨è¿›å…¥ Completed çŠ¶æ€
        â”‚
        â”‚ DinD Container ä»åœ¨è¿è¡Œ
        â”‚ â””â”€â”€ ç­‰å¾… Pod ç»ˆæ­¢ä¿¡å·
        â”‚
T+165s  â”‚ ========== é˜¶æ®µ 8: æ¸…ç†é˜¶æ®µ ==========
        â”‚
        â”‚ Kubernetes å‘é€ SIGTERM åˆ°æ‰€æœ‰å®¹å™¨
        â”‚
        â”‚ DinD æ¥æ”¶ä¿¡å·
        â”‚ æ—¥å¿—:
        â”‚   time="..." level=info msg="Processing signal 'terminated'"
        â”‚   time="..." level=info msg="Stopping daemon"
        â”‚   time="..." level=info msg="Daemon shutdown complete"
        â”‚
        â”‚ DinD ä¼˜é›…é€€å‡º (5s)
        â”‚ â””â”€â”€ åœæ­¢ containerd
        â”‚ â””â”€â”€ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        â”‚ â””â”€â”€ é‡Šæ”¾ç«¯å£
        â”‚
T+170s  â”‚ Pod åˆ é™¤å®Œæˆ
```

#### 4.3 é‡è¦æ¾„æ¸…ï¼šè°åœ¨å“ªé‡Œæ‰§è¡Œï¼Ÿ

å¾ˆå¤šäººå®¹æ˜“è¯¯è§£ï¼š**`docker build` å‘½ä»¤åœ¨ Build Container æ‰§è¡Œï¼Œä½†å®é™…æ„å»ºå·¥ä½œåœ¨ DinD Container è¿›è¡Œ**ã€‚

è¿™æ˜¯å› ä¸º Docker é‡‡ç”¨çš„æ˜¯**å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„**ã€‚

##### ğŸ“Œ Docker å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Job Pod                              â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Build Container  â”‚         â”‚  DinD Container  â”‚     â”‚
â”‚  â”‚                  â”‚         â”‚                  â”‚     â”‚
â”‚  â”‚ âœ… æ‰§è¡Œå‘½ä»¤çš„åœ°æ–¹  â”‚         â”‚ âœ… å¹²æ´»çš„åœ°æ–¹      â”‚     â”‚
â”‚  â”‚ (å®¢æˆ·ç«¯)         â”‚         â”‚ (æœåŠ¡å™¨)         â”‚     â”‚
â”‚  â”‚                  â”‚         â”‚                  â”‚     â”‚
â”‚  â”‚ $ docker build   â”‚â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  dockerd è¿›ç¨‹    â”‚     â”‚
â”‚  â”‚   â†‘             â”‚  API    â”‚   â†“             â”‚     â”‚
â”‚  â”‚   åªæ˜¯å®¢æˆ·ç«¯å·¥å…·  â”‚  è¯·æ±‚   â”‚   çœŸæ­£çš„æ„å»ºå¼•æ“  â”‚     â”‚
â”‚  â”‚                  â”‚         â”‚                  â”‚     â”‚
â”‚  â”‚ èŒè´£:            â”‚         â”‚ èŒè´£:            â”‚     â”‚
â”‚  â”‚ - è¯»å– Dockerfileâ”‚         â”‚ - æ‹‰å–åŸºç¡€é•œåƒ    â”‚     â”‚
â”‚  â”‚ - æ‰“åŒ…ä»£ç ç›®å½•    â”‚         â”‚ - è§£å‹æ„å»ºä¸Šä¸‹æ–‡  â”‚     â”‚
â”‚  â”‚ - å‘é€ API è¯·æ±‚  â”‚         â”‚ - æ‰§è¡Œ RUN æŒ‡ä»¤   â”‚     â”‚
â”‚  â”‚ - æ˜¾ç¤ºæ„å»ºæ—¥å¿—    â”‚         â”‚ - åˆ›å»ºé•œåƒå±‚      â”‚     â”‚
â”‚  â”‚                  â”‚         â”‚ - ç”Ÿæˆé•œåƒ ID     â”‚     â”‚
â”‚  â”‚ ä¸åš:            â”‚         â”‚ ä¸åš:            â”‚     â”‚
â”‚  â”‚ - ä¸æ‹‰å–é•œåƒ      â”‚         â”‚ - ä¸è¯»ç”¨æˆ·è¾“å…¥    â”‚     â”‚
â”‚  â”‚ - ä¸æ‰§è¡Œ RUN æŒ‡ä»¤â”‚         â”‚ - ä¸æ˜¾ç¤ºç»ˆç«¯è¾“å‡º  â”‚     â”‚
â”‚  â”‚ - ä¸åˆ›å»ºé•œåƒå±‚    â”‚         â”‚                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### ğŸ“Š è¯¦ç»†èŒè´£åˆ’åˆ†è¡¨

| æ­¥éª¤ | Build Container åšä»€ä¹ˆ | DinD Container åšä»€ä¹ˆ | å‘ç”Ÿä½ç½® |
|------|----------------------|---------------------|---------|
| **1. å¯åŠ¨å‘½ä»¤** | æ‰§è¡Œ `docker build -t myapp .` | dockerd å®ˆæŠ¤è¿›ç¨‹ç›‘å¬ 2375 ç«¯å£ | Build |
| **2. å‡†å¤‡é˜¶æ®µ** | è¯»å–å½“å‰ç›®å½•çš„ Dockerfile | ç­‰å¾…æ¥æ”¶è¯·æ±‚ | Build |
| **3. æ‰“åŒ…ä¸Šä¸‹æ–‡** | å°†å½“å‰ç›®å½•æ‰“åŒ…æˆ tar æ–‡ä»¶ (5MB) | - | Build |
| **4. å‘é€è¯·æ±‚** | é€šè¿‡ HTTP POST å‘é€ tar åˆ°<br>`tcp://docker:2375/build` | æ¥æ”¶ tar æµï¼Œè§£å‹åˆ°<br>`/tmp/docker-build-xxx` | Build â†’ DinD |
| **5. è§£æ Dockerfile** | - | è¯»å– Dockerfileï¼Œè§£ææŒ‡ä»¤ | DinD |
| **6. æ‹‰å–é•œåƒ** | - | **æ‰§è¡Œ `FROM python:3.9-slim`**<br>DNS è§£æã€æ‹‰å–é•œåƒ (35s) | DinD |
| **7. æ„å»ºå±‚** | æ¥æ”¶å¹¶æ˜¾ç¤ºæ—¥å¿—æµ | **æ‰§è¡Œ `RUN pip install`**<br>åœ¨ä¸´æ—¶å®¹å™¨ä¸­è¿è¡Œå‘½ä»¤ | DinD |
| **8. å®Œæˆ** | æ˜¾ç¤º "Successfully built abc123" | æäº¤é•œåƒå±‚ï¼Œç”Ÿæˆé•œåƒ ID | DinD â†’ Build |

##### ğŸ” æ‰§è¡Œæµç¨‹æ”¾å¤§é•œ

```
ç”¨æˆ·åœ¨ Build Container çš„ shell ä¸­æ‰§è¡Œ:
$ docker build -t myapp .

    â†“ ã€Build Container å†…éƒ¨ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: docker CLI æ‰«æå½“å‰ç›®å½•                 â”‚
â”‚ - è¯»å– Dockerfile                              â”‚
â”‚ - æ‰«ææ‰€æœ‰æ–‡ä»¶                                  â”‚
â”‚ - åˆ›å»º .tar.gz (æ„å»ºä¸Šä¸‹æ–‡)                     â”‚
â”‚ - å¤§å°: 5MB                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ ç½‘ç»œä¼ è¾“ (localhost)
                  â”‚ HTTP POST /v1.41/build?t=myapp
                  â”‚ Content-Type: application/x-tar
                  â”‚ Body: <5MB tar æµ>
                  â†“
    â†“ ã€DinD Container å†…éƒ¨ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: dockerd æ¥æ”¶è¯·æ±‚                        â”‚
â”‚ - ç›‘å¬ç«¯å£ 2375                                â”‚
â”‚ - æ¥æ”¶ tar æµ                                  â”‚
â”‚ - è§£å‹åˆ° /tmp/docker-build-abc123/             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: dockerd è¯»å– Dockerfile                 â”‚
â”‚ FROM python:3.9-slim                           â”‚
â”‚ COPY . .                                       â”‚
â”‚ RUN pip install -r requirements.txt            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: dockerd æ‹‰å–åŸºç¡€é•œåƒ                    â”‚
â”‚ - DNS è§£æ registry.example.com (DinD çš„ DNS) â”‚
â”‚ - HTTPS è¿æ¥ 203.0.113.10:443                  â”‚
â”‚ - ä¸‹è½½ python:3.9-slim (50MB)                 â”‚
â”‚ - ä¿å­˜åˆ° /var/lib/docker/image/               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ æµå¼è¿”å›æ—¥å¿— (JSON)
                  â”‚ {"stream": "Pulling from library/python\n"}
                  â”‚ {"status": "Downloading", "progress": "[=>]"}
                  â†“
    â†‘ ã€Build Container æ¥æ”¶æ—¥å¿—ã€‘
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç»ˆç«¯æ˜¾ç¤º:                           â”‚
    â”‚ Pulling from library/python        â”‚
    â”‚ Layer 1: Downloading [=>  ] 5MB    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“ ã€ç»§ç»­åœ¨ DinD Containerã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: dockerd æ‰§è¡Œ COPY æŒ‡ä»¤                  â”‚
â”‚ - ä» /tmp/docker-build-abc123/ å¤åˆ¶æ–‡ä»¶        â”‚
â”‚ - åˆ›å»ºæ–°çš„é•œåƒå±‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: dockerd æ‰§è¡Œ RUN æŒ‡ä»¤                   â”‚
â”‚ - åŸºäº python:3.9-slim åˆ›å»ºä¸´æ—¶å®¹å™¨            â”‚
â”‚ - åœ¨ä¸´æ—¶å®¹å™¨ä¸­æ‰§è¡Œ: pip install                â”‚
â”‚ - æäº¤å®¹å™¨ä¸ºæ–°çš„é•œåƒå±‚                          â”‚
â”‚ - åˆ é™¤ä¸´æ—¶å®¹å™¨                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: dockerd å®Œæˆæ„å»º                        â”‚
â”‚ - ç”Ÿæˆé•œåƒ ID: sha256:abc123...               â”‚
â”‚ - æ‰“æ ‡ç­¾: myapp:latest                         â”‚
â”‚ - å­˜å‚¨åˆ° /var/lib/docker/                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ è¿”å›æˆåŠŸ (JSON)
                  â”‚ {"stream": "Successfully built abc123...\n"}
                  â”‚ {"stream": "Successfully tagged myapp:latest\n"}
                  â†“
    â†‘ ã€Build Container æ¥æ”¶ç»“æœã€‘
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç»ˆç«¯æ˜¾ç¤º:                           â”‚
    â”‚ Successfully built abc123...       â”‚
    â”‚ Successfully tagged myapp:latest   â”‚
    â”‚                                    â”‚
    â”‚ $ (å‘½ä»¤æ‰§è¡Œå®Œæˆï¼Œè¿”å› shell æç¤ºç¬¦) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### ğŸ¯ ç±»æ¯”ç†è§£

**ç±»æ¯” 1ï¼šé¤å…ç‚¹é¤**
```
Build Container = é¡¾å®¢
  â””â”€â”€ è¯´ï¼š"æˆ‘è¦ä¸€ä»½ç‚’é¥­"ï¼ˆdocker buildï¼‰
  â””â”€â”€ ç­‰å¾…ä¸Šèœï¼ˆæ¥æ”¶æ—¥å¿—ï¼‰
  â””â”€â”€ åƒé¥­ï¼ˆä½¿ç”¨æ„å»ºå¥½çš„é•œåƒï¼‰

DinD Container = å¨æˆ¿
  â””â”€â”€ æ¥å•ï¼ˆæ¥æ”¶ API è¯·æ±‚ï¼‰
  â””â”€â”€ å‡†å¤‡é£Ÿæï¼ˆæ‹‰å–åŸºç¡€é•œåƒï¼‰
  â””â”€â”€ ç‚’èœï¼ˆæ‰§è¡Œ Dockerfile æŒ‡ä»¤ï¼‰
  â””â”€â”€ å‡ºé¤ï¼ˆè¿”å›é•œåƒ IDï¼‰

é¡¾å®¢ä¸ä¼šè‡ªå·±ç‚’èœï¼Œå¨æˆ¿ä¸ä¼šç›´æ¥é¢å¯¹é¡¾å®¢
```

**ç±»æ¯” 2ï¼šæµè§ˆå™¨è®¿é—®ç½‘ç«™**
```
Build Container = Chrome æµè§ˆå™¨
  â””â”€â”€ è¾“å…¥ç½‘å€ï¼Œç‚¹å‡»"æœç´¢"
  â””â”€â”€ å‘é€ HTTP è¯·æ±‚
  â””â”€â”€ æ˜¾ç¤ºè¿”å›çš„ HTML

DinD Container = Web æœåŠ¡å™¨
  â””â”€â”€ æ¥æ”¶è¯·æ±‚
  â””â”€â”€ æŸ¥è¯¢æ•°æ®åº“
  â””â”€â”€ ç”Ÿæˆ HTML
  â””â”€â”€ è¿”å›ç»™æµè§ˆå™¨

æµè§ˆå™¨ä¸å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ŒæœåŠ¡å™¨ä¸æ˜¾ç¤ºé¡µé¢
```

##### â“ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

**1. åˆ†ç¦»å…³æ³¨ç‚¹**
- Build Containerï¼šç”¨æˆ·äº¤äº’ã€è„šæœ¬æ‰§è¡Œ
- DinD Containerï¼šDocker å¼•æ“ã€é•œåƒç®¡ç†

**2. èµ„æºéš”ç¦»**
- æ„å»ºå¤±è´¥ä¸ä¼šå¯¼è‡´ Build Container å´©æºƒ
- å¯ä»¥ç‹¬ç«‹é™åˆ¶ DinD çš„èµ„æºä½¿ç”¨ï¼ˆCPU/å†…å­˜ï¼‰

**3. å®‰å…¨æ€§**
- Build Container ä¸éœ€è¦ç‰¹æƒæ¨¡å¼
- åªæœ‰ DinD éœ€è¦ `privileged: true`
- é™ä½å®‰å…¨é£é™©

**4. çµæ´»æ€§**
- å¯ä»¥è¿æ¥è¿œç¨‹ Docker å®ˆæŠ¤è¿›ç¨‹
- åŒä¸€ä¸ª DinD å¯ä»¥æœåŠ¡å¤šä¸ªæ„å»ºä»»åŠ¡ï¼ˆè™½ç„¶ GitLab Runner ä¸è¿™ä¹ˆç”¨ï¼‰

##### ğŸ” éªŒè¯æ–¹å¼

**åœ¨ Build Container ä¸­æŸ¥çœ‹ï¼š**
```bash
# åªæœ‰ docker å‘½ä»¤è¡Œå·¥å…·
$ which docker
/usr/local/bin/docker

# æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ç¨‹åº
$ file /usr/local/bin/docker
/usr/local/bin/docker: ELF 64-bit LSB executable

# æ²¡æœ‰ dockerd å®ˆæŠ¤è¿›ç¨‹
$ which dockerd
(not found)

# è¿æ¥çš„æ˜¯è¿œç¨‹ dockerd
$ echo $DOCKER_HOST
tcp://docker:2375

# è¿›ç¨‹åˆ—è¡¨ä¸­æ²¡æœ‰ dockerd
$ ps aux | grep dockerd
(no results)
```

**åœ¨ DinD Container ä¸­æŸ¥çœ‹ï¼š**
```bash
# æœ‰ dockerd å®ˆæŠ¤è¿›ç¨‹
$ ps aux | grep dockerd
root  21  dockerd --host=tcp://0.0.0.0:2375 --tls=false

# å®ˆæŠ¤è¿›ç¨‹ç›‘å¬ç«¯å£
$ netstat -tuln | grep 2375
tcp6  0  0  :::2375  :::*  LISTEN

# ä¹Ÿæœ‰ docker CLIï¼ˆä½†å¾ˆå°‘ç”¨ï¼‰
$ which docker
/usr/local/bin/docker
```

##### ğŸ“Œ æ€»ç»“

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| `docker build` å‘½ä»¤åœ¨å“ªé‡Œæ‰§è¡Œï¼Ÿ | âœ… Build Containerï¼ˆå‘½ä»¤è¡Œè¾“å…¥ï¼‰ |
| Dockerfile åœ¨å“ªé‡Œè¯»å–ï¼Ÿ | âœ… Build Containerï¼ˆæ‰“åŒ…ä¸Šä¸‹æ–‡æ—¶ï¼‰<br>âœ… DinD Containerï¼ˆè§£ææŒ‡ä»¤æ—¶ï¼‰ |
| åŸºç¡€é•œåƒåœ¨å“ªé‡Œæ‹‰å–ï¼Ÿ | âœ… DinD Container |
| `RUN pip install` åœ¨å“ªé‡Œæ‰§è¡Œï¼Ÿ | âœ… DinD Containerï¼ˆä¸´æ—¶å®¹å™¨ä¸­ï¼‰ |
| é•œåƒå±‚åœ¨å“ªé‡Œåˆ›å»ºï¼Ÿ | âœ… DinD Container |
| é•œåƒå­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ | âœ… DinD Containerï¼ˆ`/var/lib/docker/`ï¼‰ |
| æ„å»ºæ—¥å¿—åœ¨å“ªé‡Œæ˜¾ç¤ºï¼Ÿ | âœ… Build Containerï¼ˆç»ˆç«¯è¾“å‡ºï¼‰ |
| DNS è§£æåœ¨å“ªé‡Œå‘ç”Ÿï¼Ÿ | âœ… DinD Containerï¼ˆæ‹‰å–é•œåƒæ—¶ï¼‰ |

**æ ¸å¿ƒç»“è®º**ï¼š
- âœ… **å‘½ä»¤åœ¨ Build Container æ‰§è¡Œ**ï¼ˆç”¨æˆ·ç•Œé¢ï¼‰
- âœ… **å·¥ä½œåœ¨ DinD Container è¿›è¡Œ**ï¼ˆå®é™…å¼•æ“ï¼‰
- ğŸ”‘ **Build Container åªæ˜¯å®¢æˆ·ç«¯**ï¼Œé€šè¿‡ç½‘ç»œ API è°ƒç”¨ DinD

è¿™å°±åƒä½ åœ¨æ‰‹æœºä¸Šç‚¹"å¤–å–"ï¼Œä½†åšé¥­çš„æ˜¯é¤å…ï¼Œä¸æ˜¯ä½ çš„æ‰‹æœºï¼

---

#### 4.4 ä¸ Build Container çš„äº¤äº’æœºåˆ¶

**é€šä¿¡åè®®**: Docker Remote API (REST over TCP)

**äº¤äº’æ¨¡å¼**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Job Pod                          â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Build Container  â”‚      â”‚  DinD Container  â”‚   â”‚
â”‚  â”‚                  â”‚      â”‚                  â”‚   â”‚
â”‚  â”‚  docker CLI      â”‚      â”‚    dockerd       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ version     â”‚      â”‚    â””â”€â”€ API       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ build       â”‚      â”‚        Server    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ push        â”‚      â”‚        :2375     â”‚   â”‚
â”‚  â”‚  â””â”€â”€ ...         â”‚      â”‚                  â”‚   â”‚
â”‚  â”‚                  â”‚      â”‚                  â”‚   â”‚
â”‚  â”‚  ç¯å¢ƒå˜é‡:        â”‚      â”‚  ç›‘å¬ç«¯å£:        â”‚   â”‚
â”‚  â”‚  DOCKER_HOST=    â”‚      â”‚  - 2375/tcp      â”‚   â”‚
â”‚  â”‚  tcp://docker:2375     â”‚  - /var/run/     â”‚   â”‚
â”‚  â”‚                  â”‚      â”‚    docker.sock   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                         â”‚             â”‚
â”‚           â”‚    HTTP/REST API        â”‚             â”‚
â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
â”‚           â”‚                         â”‚             â”‚
â”‚  å…±äº«ç½‘ç»œå‘½åç©ºé—´ (localhost)                       â”‚
â”‚  /etc/hosts: 127.0.0.1 docker                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…¸å‹ API è°ƒç”¨ç¤ºä¾‹**:

1. **docker info**
   ```
   Build â†’ DinD: GET /v1.41/info
   DinD â†’ Build: 200 OK
   {
     "ServerVersion": "27.1.1",
     "StorageDriver": "vfs",
     "Containers": 0,
     "Images": 0
   }
   ```

2. **docker build**
   ```
   Build â†’ DinD: POST /v1.41/build?t=myapp:latest
   Content-Type: application/x-tar
   Body: <tar æµ>
   
   DinD â†’ Build: 200 OK (æµå¼å“åº”)
   {"stream": "Step 1/5 : FROM python:3.9-slim\n"}
   {"stream": "Pulling from library/python\n"}
   {"status": "Downloading", "progress": "[===>  ] 15MB/50MB"}
   ...
   {"stream": "Successfully built abc123def456\n"}
   {"stream": "Successfully tagged myapp:latest\n"}
   ```

3. **docker push**
   ```
   Build â†’ DinD: POST /v1.41/images/myapp:latest/push
   X-Registry-Auth: <base64_encoded_credentials>
   
   DinD â†’ Build: 200 OK (æµå¼å“åº”)
   {"status": "The push refers to repository [...]"}
   {"status": "Preparing"}
   {"status": "Pushing", "progress": "[=>  ] 10MB/50MB"}
   ...
   {"status": "56cc4792-86: digest: sha256:... size: 1234"}
   ```

#### 4.4 ç»“æœåé¦ˆæœºåˆ¶

**1. å®æ—¶æ—¥å¿—æµ**

DinD å°†æ“ä½œæ—¥å¿—é€šè¿‡ API å“åº”æµå®æ—¶è¿”å›ç»™ Build Containerï¼š

```
Build Container stdout:
  Step 1/5 : FROM python:3.9-slim    â† DinD è¿”å›
  ---> Pulling from library/python   â† DinD è¿”å›
  Layer 1: Downloading [=>  ] 5MB    â† DinD è¿”å›ï¼ˆå®æ—¶æ›´æ–°ï¼‰
  Layer 1: Download complete         â† DinD è¿”å›
  Successfully built abc123def456    â† DinD è¿”å›
```

**2. é€€å‡ºç ä¼ é€’**

```
DinD æ‰§è¡Œç»“æœ â†’ HTTP çŠ¶æ€ç  â†’ Build Container è§£æ â†’ Shell é€€å‡ºç 

æˆåŠŸ: 200 OK â†’ exit 0
å¤±è´¥: 500 Internal Server Error â†’ exit 1
```

**3. é•œåƒ ID ä¼ é€’**

```
docker build æˆåŠŸå:
  DinD ç”Ÿæˆ: Image ID = sha256:abc123...
  â†“
  è¿”å› JSON: {"stream": "Successfully built abc123...\n"}
  â†“
  docker CLI è§£æå¹¶å­˜å‚¨
  â†“
  åç»­å‘½ä»¤å¯å¼•ç”¨: docker push abc123...
```

**4. æ•°æ®æŒä¹…åŒ–**ï¼ˆé•œåƒå­˜å‚¨ï¼‰

```
DinD å†…éƒ¨å­˜å‚¨:
  /var/lib/docker/
  â”œâ”€â”€ image/
  â”‚   â””â”€â”€ vfs/
  â”‚       â””â”€â”€ imagedb/
  â”‚           â””â”€â”€ content/
  â”‚               â””â”€â”€ sha256/
  â”‚                   â””â”€â”€ abc123... (é•œåƒå…ƒæ•°æ®)
  â”‚
  â””â”€â”€ vfs/
      â””â”€â”€ dir/
          â””â”€â”€ abc123... (é•œåƒå±‚æ•°æ®)

è¿™äº›æ•°æ®åœ¨ DinD å®¹å™¨å†…ï¼ŒPod é”€æ¯åä¸¢å¤±
å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“çš„é•œåƒä¸å—å½±å“
```

#### 4.5 ç½‘ç»œä¸ DNS é…ç½®

##### ğŸ“¡ ä¸ºä»€ä¹ˆ DNS é…ç½®æ˜¯å…³é”®ï¼Ÿ

åœ¨ DinD åœºæ™¯ä¸­ï¼ŒDNS è§£ææ˜¯**æœ€å¸¸è§çš„æ•…éšœç‚¹**ï¼Œå› ä¸ºï¼š
1. **dockerd éœ€è¦æ‹‰å–é•œåƒ** â†’ å¿…é¡»èƒ½è§£æ `registry.example.com`
2. **é»˜è®¤ kube-dns åªè§£æé›†ç¾¤å†…æœåŠ¡** â†’ æ— æ³•è§£æå¤–éƒ¨åŸŸå
3. **--dns å‚æ•°å®¹æ˜“è¯¯è§£** â†’ å¾ˆå¤šäººä»¥ä¸ºå®ƒå½±å“ dockerd è‡ªå·±çš„ DNS

##### ğŸ”„ DNS é…ç½®çš„ä¼ é€’æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é…ç½®æ¥æºä¸ä¼ é€’è·¯å¾„                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç¬¬ 1 å±‚ï¼šRunner é…ç½®ã€‘gitlab-runner-values.yaml
    â”‚
    â”‚  dns_policy = "none"
    â”‚  [runners.kubernetes.dns_config]
    â”‚    nameservers = ["10.0.0.2", "10.1.0.251", "10.1.0.252"]
    â”‚
    â†“ Runner Manager åˆ›å»º Job Pod æ—¶åº”ç”¨æ­¤é…ç½®

ã€ç¬¬ 2 å±‚ï¼šJob Pod é…ç½®ã€‘Kubernetes Pod Spec
    â”‚
    â”‚  spec:
    â”‚    dnsPolicy: None
    â”‚    dnsConfig:
    â”‚      nameservers:
    â”‚        - 10.0.0.2
    â”‚        - 10.1.0.251
    â”‚        - 10.1.0.252
    â”‚      searches: ["gitlab.svc.cluster.local", "svc.cluster.local"]
    â”‚
    â†“ Kubernetes å°†æ­¤é…ç½®å†™å…¥å®¹å™¨çš„ /etc/resolv.conf

ã€ç¬¬ 3 å±‚ï¼šå®¹å™¨å†…éƒ¨æ–‡ä»¶ã€‘/etc/resolv.confï¼ˆæ‰€æœ‰å®¹å™¨å…±äº«ï¼‰
    â”‚
    â”‚  nameserver 10.0.0.2
    â”‚  nameserver 10.1.0.251
    â”‚  nameserver 10.1.0.252
    â”‚  search gitlab.svc.cluster.local svc.cluster.local cluster.local
    â”‚  options ndots:2
    â”‚
    â†“ Build Containerã€Helperã€DinD éƒ½ç»§æ‰¿è¿™ä¸ªé…ç½®

ã€ç¬¬ 4 å±‚ï¼šåº”ç”¨ä½¿ç”¨ã€‘
    â”œâ”€â†’ Build Container çš„ DNS æŸ¥è¯¢ â†’ è¯»å– /etc/resolv.conf
    â”œâ”€â†’ Helper Container çš„ DNS æŸ¥è¯¢ â†’ è¯»å– /etc/resolv.conf
    â””â”€â†’ DinD Container çš„ dockerd è¿›ç¨‹ â†’ è¯»å– /etc/resolv.conf âœ… å…³é”®ï¼
```

##### âš ï¸ æœ€å®¹æ˜“æ··æ·†çš„æ¦‚å¿µï¼š`--dns` å‚æ•°çš„ä¸¤å±‚å«ä¹‰

**é”™è¯¯ç†è§£**ï¼š
```yaml
services:
  - name: docker:dind
    command:
      - "--dns=8.8.8.8"  # âŒ å¾ˆå¤šäººä»¥ä¸ºè¿™é…ç½®çš„æ˜¯ dockerd è‡ªå·±çš„ DNS
```

**æ­£ç¡®ç†è§£**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           dockerd çš„ DNS é…ç½® - ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„å±‚é¢                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€åœºæ™¯ 1ï¼šdockerd è¿›ç¨‹æœ¬èº«æ‹‰å–é•œåƒã€‘
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ—¶æœºï¼šæ‰§è¡Œ docker build æ—¶ï¼ŒFROM python:3.9-slim         â”‚
  â”‚                                                         â”‚
  â”‚ dockerd è¿›ç¨‹å‘èµ· DNS æŸ¥è¯¢ï¼š                               â”‚
  â”‚   åŸŸåï¼šregistry.example.com                            â”‚
  â”‚   â†“                                                     â”‚
  â”‚   è¯»å–ï¼š/etc/resolv.conf (å®¹å™¨è‡ªå·±çš„)                     â”‚
  â”‚   â†“                                                     â”‚
  â”‚   ä½¿ç”¨ï¼š10.0.0.2 (æ¥è‡ª Job Pod çš„ dnsConfig)            â”‚
  â”‚   â†“                                                     â”‚
  â”‚   ç»“æœï¼šè§£æåˆ° 203.0.113.10                              â”‚
  â”‚                                                         â”‚
  â”‚ ğŸ’¡ --dns å‚æ•°å¯¹æ­¤æ— æ•ˆï¼                                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€åœºæ™¯ 2ï¼šdockerd åˆ›å»ºçš„å®¹å™¨å†…éƒ¨ã€‘
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ—¶æœºï¼šæ‰§è¡Œ RUN pip install æ—¶ï¼Œåœ¨ä¸´æ—¶å®¹å™¨ä¸­               â”‚
  â”‚                                                         â”‚
  â”‚ dockerd åˆ›å»ºä¸´æ—¶å®¹å™¨ï¼Œå¹¶è®¾ç½®å…¶ /etc/resolv.confï¼š         â”‚
  â”‚   nameserver 8.8.8.8  â† æ¥è‡ª --dns=8.8.8.8 å‚æ•°        â”‚
  â”‚   â†“                                                     â”‚
  â”‚   ä¸´æ—¶å®¹å™¨å†…çš„ pip å‘½ä»¤å‘èµ· DNS æŸ¥è¯¢ï¼š                    â”‚
  â”‚   åŸŸåï¼špypi.org                                        â”‚
  â”‚   â†“                                                     â”‚
  â”‚   ä½¿ç”¨ï¼š8.8.8.8                                         â”‚
  â”‚   â†“                                                     â”‚
  â”‚   ç»“æœï¼šè§£æåˆ° PyPI çš„ IP                                â”‚
  â”‚                                                         â”‚
  â”‚ ğŸ’¡ --dns å‚æ•°åœ¨æ­¤ç”Ÿæ•ˆï¼                                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### ğŸ“Š å¯¹æ¯”è¡¨ï¼šä¸¤ç§ DNS é…ç½®

| å¯¹æ¯”é¡¹ | Pod dnsConfig | DinD --dns å‚æ•° |
|--------|--------------|----------------|
| **é…ç½®ä½ç½®** | gitlab-runner-values.yaml | .gitlab-ci.yml services.command |
| **å½±å“å¯¹è±¡** | DinD å®¹å™¨çš„ /etc/resolv.conf | dockerd åˆ›å»ºçš„ä¸´æ—¶å®¹å™¨çš„ /etc/resolv.conf |
| **ç”Ÿæ•ˆæ—¶æœº** | å®¹å™¨å¯åŠ¨æ—¶ | dockerd æ‰§è¡Œ RUN æŒ‡ä»¤æ—¶ |
| **å½±å“èŒƒå›´** | **dockerd è¿›ç¨‹è‡ªå·±**çš„ DNS æŸ¥è¯¢ | dockerd **åˆ›å»ºçš„å®¹å™¨å†…éƒ¨**çš„ DNS æŸ¥è¯¢ |
| **å…¸å‹åœºæ™¯** | æ‹‰å–é•œåƒï¼ˆFROM python:3.9ï¼‰ | å®¹å™¨å†…å®‰è£…è½¯ä»¶ï¼ˆRUN pip installï¼‰ |
| **é…ç½®ç¤ºä¾‹** | `nameservers: ["10.0.0.2"]` | `command: ["--dns=8.8.8.8"]` |
| **è§£å†³çš„é—®é¢˜** | âœ… è§£æé•œåƒä»“åº“åŸŸå | âœ… å®¹å™¨å†…éƒ¨è®¿é—®å¤–ç½‘ |
| **ä¸è§£å†³çš„é—®é¢˜** | âŒ å®¹å™¨å†…éƒ¨çš„ DNS | âŒ dockerd æ‹‰å–é•œåƒçš„ DNS |

##### ğŸ¯ å®é™…åœºæ™¯æ¼”ç¤º

**åœºæ™¯ 1ï¼šdocker build æ‹‰å–åŸºç¡€é•œåƒ**
```bash
# .gitlab-ci.yml ä¸­æ‰§è¡Œ
docker build -t myapp .

# Dockerfile å†…å®¹
FROM registry.example.com/python:3.9-slim
RUN pip install flask

# DNS è§£ææµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ‹‰å– FROM æŒ‡å®šçš„åŸºç¡€é•œåƒ                          â”‚
â”‚                                                         â”‚
â”‚ dockerd è¿›ç¨‹éœ€è¦è§£æï¼š                                    â”‚
â”‚   registry.example.com                                 â”‚
â”‚   â†“                                                     â”‚
â”‚ dockerd è¯»å–è‡ªå·±çš„ /etc/resolv.confï¼š                    â”‚
â”‚   nameserver 10.0.0.2  â† æ¥è‡ª Pod dnsConfig            â”‚
â”‚   â†“                                                     â”‚
â”‚ æŸ¥è¯¢ç»“æœï¼š203.0.113.10                                   â”‚
â”‚ âœ… æˆåŠŸæ‹‰å–é•œåƒ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: åœ¨ä¸´æ—¶å®¹å™¨ä¸­æ‰§è¡Œ RUN æŒ‡ä»¤                         â”‚
â”‚                                                         â”‚
â”‚ dockerd åˆ›å»ºä¸´æ—¶å®¹å™¨æ‰§è¡Œï¼špip install flask              â”‚
â”‚                                                         â”‚
â”‚ ä¸´æ—¶å®¹å™¨éœ€è¦è§£æï¼špypi.org                               â”‚
â”‚   â†“                                                     â”‚
â”‚ dockerd ä¸ºä¸´æ—¶å®¹å™¨è®¾ç½® /etc/resolv.confï¼š                â”‚
â”‚   å¦‚æœæœ‰ --dns=8.8.8.8 â†’ nameserver 8.8.8.8           â”‚
â”‚   å¦‚æœæ²¡æœ‰ --dns â†’ ç»§æ‰¿ DinD å®¹å™¨çš„é…ç½®                   â”‚
â”‚   â†“                                                     â”‚
â”‚ æŸ¥è¯¢ pypi.org å¹¶ä¸‹è½½ flask                              â”‚
â”‚ âœ… å®‰è£…æˆåŠŸ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### ğŸ› ï¸ æ­£ç¡®é…ç½®ç¤ºä¾‹

**æœ¬é¡¹ç›®çš„å®Œæ•´é…ç½®**ï¼š

```yaml
# ============================================
# æ–‡ä»¶ 1: gitlab-runner-values.yaml
# ============================================
runners:
  config: |
    [[runners]]
      executor = "kubernetes"
      [runners.kubernetes]
        # ğŸ”‘ å…³é”®é…ç½®ï¼šè®© DinD å®¹å™¨èƒ½æ‹‰å–é•œåƒ
        dns_policy = "none"
        [runners.kubernetes.dns_config]
          nameservers = ["10.0.0.2", "10.1.0.251", "10.1.0.252"]
          searches = ["gitlab.svc.cluster.local", "svc.cluster.local", "cluster.local"]
          [[runners.kubernetes.dns_config.options]]
            name = "ndots"
            value = "2"

# ============================================
# æ–‡ä»¶ 2: .gitlab-ci.yml
# ============================================
services:
  - name: registry.example.com/docker:dind
    alias: docker
    command:
      - "--tls=false"
      - "--insecure-registry=private-registry.example.com"
      # æ³¨æ„ï¼šæ²¡æœ‰ --dns å‚æ•°ï¼Œå› ä¸ºï¼š
      # 1. dockerd æ‹‰å–é•œåƒå·²é€šè¿‡ Pod dnsConfig è§£å†³
      # 2. RUN æŒ‡ä»¤å†…çš„ç½‘ç»œè®¿é—®ä¼šç»§æ‰¿ DinD å®¹å™¨çš„ DNS (10.0.0.2)
      # 3. å¦‚æœ RUN æŒ‡ä»¤éœ€è¦ç‰¹æ®Š DNSï¼Œå¯ä»¥æ·»åŠ  --dns=8.8.8.8
```

##### ğŸ” éªŒè¯ DNS é…ç½®çš„æ–¹æ³•

**1. æ£€æŸ¥ DinD å®¹å™¨çš„ DNS é…ç½®**
```bash
# æŸ¥çœ‹ DinD å®¹å™¨çš„ /etc/resolv.conf
kubectl exec -n gitlab <job-pod-name> -c docker -- cat /etc/resolv.conf

# é¢„æœŸè¾“å‡ºï¼š
nameserver 10.0.0.2
nameserver 10.1.0.251
nameserver 10.1.0.252
search gitlab.svc.cluster.local svc.cluster.local cluster.local
options ndots:2
```

**2. æµ‹è¯• DinD å®¹å™¨èƒ½å¦è§£æé•œåƒä»“åº“**
```bash
# åœ¨ DinD å®¹å™¨å†…æµ‹è¯• DNS è§£æ
kubectl exec -n gitlab <job-pod-name> -c docker -- \
  nslookup registry.example.com

# é¢„æœŸè¾“å‡ºï¼š
Server:    10.0.0.2
Address 1: 10.0.0.2

Name:      registry.example.com
Address 1: 203.0.113.10
```

**3. æµ‹è¯• dockerd èƒ½å¦æ‹‰å–é•œåƒ**
```bash
# åœ¨ Build Container ä¸­æ‰§è¡Œ
kubectl exec -n gitlab <job-pod-name> -c build -- \
  docker -H tcp://docker:2375 pull alpine:latest

# å¦‚æœæˆåŠŸï¼Œè¯´æ˜ DNS é…ç½®æ­£ç¡®
```

##### âŒ å¸¸è§é”™è¯¯é…ç½®

**é”™è¯¯ 1ï¼šåªé…ç½® --dns å‚æ•°ï¼Œä¸é…ç½® Pod dnsConfig**
```yaml
# âŒ é”™è¯¯é…ç½®
services:
  - name: docker:dind
    command:
      - "--dns=8.8.8.8"  # è¿™ä¸ªä¸å½±å“ dockerd æ‹‰å–é•œåƒ

# ç»“æœï¼š
# FROM python:3.9 â†’ DNS è§£æå¤±è´¥
# å› ä¸º dockerd è¯»å–çš„æ˜¯ /etc/resolv.confï¼ˆé»˜è®¤æŒ‡å‘ kube-dnsï¼‰
```

**é”™è¯¯ 2ï¼šåœ¨ .gitlab-ci.yml ä¸­å°è¯•é…ç½® Pod DNS**
```yaml
# âŒ é”™è¯¯é…ç½®
variables:
  KUBERNETES_DNS_CONFIG: "10.0.0.2"  # æ— æ•ˆï¼ŒCI å˜é‡ä¸æ§åˆ¶ Pod DNS

# æ­£ç¡®åšæ³•ï¼š
# å¿…é¡»åœ¨ gitlab-runner-values.yaml çš„ runners.kubernetes.dns_config ä¸­é…ç½®
```

**é”™è¯¯ 3ï¼šä½¿ç”¨ kube-dns å´æœŸæœ›è§£æå¤–éƒ¨åŸŸå**
```yaml
# âŒ é”™è¯¯é…ç½®
# gitlab-runner-values.yaml ä¸­æ²¡æœ‰é…ç½® dns_policy å’Œ dns_config
# é»˜è®¤ä½¿ç”¨ kube-dns (10.96.0.10)

# ç»“æœï¼š
# kube-dns åªèƒ½è§£æé›†ç¾¤å†…æœåŠ¡ï¼ˆå¦‚ gitlab.svc.cluster.localï¼‰
# æ— æ³•è§£æ registry.example.com
```

##### ğŸš¨ æ•…éšœæ’æŸ¥æ­¥éª¤

å½“é‡åˆ° DNS ç›¸å…³é”™è¯¯æ—¶ï¼ˆå¦‚ `dial tcp: lookup xxx: i/o timeout`ï¼‰ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

**1. ç¡®è®¤ Pod çš„ DNS é…ç½®**
```bash
kubectl get pod <job-pod-name> -n gitlab -o yaml | grep -A 10 dnsPolicy

# é¢„æœŸï¼š
# dnsPolicy: None
# dnsConfig:
#   nameservers:
#   - 10.0.0.2
```

**2. ç¡®è®¤ DinD å®¹å™¨çš„ resolv.conf**
```bash
kubectl exec -n gitlab <job-pod-name> -c docker -- cat /etc/resolv.conf

# æ£€æŸ¥ nameserver æ˜¯å¦æ˜¯ 10.0.0.2 è€Œä¸æ˜¯ 10.96.0.10
```

**3. æµ‹è¯• DNS æœåŠ¡å™¨å¯è¾¾æ€§**
```bash
# ä» DinD å®¹å™¨å†… ping DNS æœåŠ¡å™¨
kubectl exec -n gitlab <job-pod-name> -c docker -- ping -c 3 10.0.0.2

# å¦‚æœä¸é€šï¼Œæ£€æŸ¥ç½‘ç»œç­–ç•¥æˆ–é˜²ç«å¢™
```

**4. æµ‹è¯•åŸŸåè§£æ**
```bash
# ä½¿ç”¨æŒ‡å®š DNS æœåŠ¡å™¨è§£æ
kubectl exec -n gitlab <job-pod-name> -c docker -- \
  nslookup registry.example.com 10.0.0.2

# å¦‚æœå¤±è´¥ï¼Œå¯èƒ½æ˜¯ DNS æœåŠ¡å™¨é…ç½®é—®é¢˜
```

**5. æ£€æŸ¥ Runner é…ç½®æ˜¯å¦ç”Ÿæ•ˆ**
```bash
# æŸ¥çœ‹ Runner Manager çš„é…ç½®
kubectl exec -n gitlab <runner-manager-pod> -- cat /home/gitlab-runner/.gitlab-runner/config.toml

# ç¡®è®¤ dns_policy å’Œ dns_config å­˜åœ¨
```

##### ğŸ“ é…ç½®æ€»ç»“

| éœ€æ±‚åœºæ™¯ | é…ç½®æ–¹æ³• | é…ç½®ä½ç½® |
|---------|---------|---------|
| **dockerd æ‹‰å–é•œåƒ** | é…ç½® Pod `dnsConfig` | `gitlab-runner-values.yaml`<br>`runners.kubernetes.dns_config` |
| **RUN æŒ‡ä»¤å†…è®¿é—®å¤–ç½‘** | æ–¹æ¡ˆ1: ç»§æ‰¿ Pod DNSï¼ˆæ¨èï¼‰<br>æ–¹æ¡ˆ2: æ·»åŠ  `--dns` å‚æ•° | ä¸é…ç½®ï¼ˆé»˜è®¤ç»§æ‰¿ï¼‰<br>æˆ– `.gitlab-ci.yml` services.command |
| **Build Container è®¿é—®å¤–ç½‘** | é…ç½® Pod `dnsConfig`ï¼ˆè‡ªåŠ¨ç”Ÿæ•ˆï¼‰ | `gitlab-runner-values.yaml` |
| **Helper Container å…‹éš†ä»£ç ** | é…ç½® Pod `dnsConfig`ï¼ˆè‡ªåŠ¨ç”Ÿæ•ˆï¼‰ | `gitlab-runner-values.yaml` |

**æ ¸å¿ƒåŸåˆ™**ï¼š
- ğŸ¯ **Pod çº§åˆ«çš„ DNS é…ç½®å½±å“æ‰€æœ‰å®¹å™¨**ï¼ˆåŒ…æ‹¬ dockerd è¿›ç¨‹ï¼‰
- ğŸ¯ **--dns å‚æ•°åªå½±å“ dockerd åˆ›å»ºçš„å®¹å™¨å†…éƒ¨**
- ğŸ¯ **ä¼˜å…ˆé…ç½® Pod dnsConfigï¼Œ--dns æŒ‰éœ€é…ç½®**

---

#### 4.6 èµ„æºæ¶ˆè€—åˆ†æ

**å¯åŠ¨é˜¶æ®µ** (T+4s â†’ T+8s):
- CPU: ~500mï¼ˆå¯åŠ¨ dockerd + containerdï¼‰
- å†…å­˜: ~200Miï¼ˆåŠ è½½æœåŠ¡ï¼‰

**ç©ºé—²é˜¶æ®µ** (T+8s â†’ T+10s):
- CPU: ~50mï¼ˆå®ˆæŠ¤è¿›ç¨‹ç­‰å¾…ï¼‰
- å†…å­˜: ~250Miï¼ˆåŸºç¡€å ç”¨ï¼‰

**æ„å»ºé˜¶æ®µ** (T+10s â†’ T+120s):
- CPU: 1.5-2 æ ¸ï¼ˆæ‹‰å–é•œåƒ + æ„å»ºï¼‰
- å†…å­˜: 1-2Giï¼ˆé•œåƒå±‚ç¼“å­˜ + æ„å»ºç¼“å­˜ï¼‰
- ç£ç›˜ I/O: ä¸­ç­‰ï¼ˆä¸‹è½½é•œåƒå±‚ï¼‰

**æ¨é€é˜¶æ®µ** (T+120s â†’ T+160s):
- CPU: ~1 æ ¸ï¼ˆå‹ç¼©ä¸Šä¼ ï¼‰
- å†…å­˜: ~500Miï¼ˆè¯»å–é•œåƒå±‚ï¼‰
- ç½‘ç»œ I/O: é«˜ï¼ˆä¸Šä¼ æ•°æ®ï¼‰

**å…³é”®é…ç½®**:
```yaml
# Runner é…ç½®
service_cpu_limit = "2"          # é˜²æ­¢ CPU è¿‡è½½
service_cpu_request = "500m"     # ä¿è¯å¯åŠ¨èµ„æº
service_memory_limit = "2Gi"     # é˜²æ­¢ OOM
service_memory_request = "512Mi" # ä¿è¯åŸºç¡€å†…å­˜

# ç‰¹æƒæ¨¡å¼ï¼ˆå¿…éœ€ï¼‰
privileged = true  # DinD éœ€è¦å†…æ ¸åŠŸèƒ½è®¿é—®
```

#### 4.7 å¸¸è§åœºæ™¯ä¸å…¶ä»– Service

**æ•°æ®åº“æœåŠ¡ç¤ºä¾‹** (MySQL):
```yaml
services:
  - name: mysql:8.0
    alias: mysql
    variables:
      MYSQL_ROOT_PASSWORD: "test123"
      MYSQL_DATABASE: "testdb"

# Build Container ä¸­:
# - ç­‰å¾… MySQL å¯åŠ¨ï¼ˆçº¦ 15sï¼‰
# - è¿æ¥: mysql -h mysql -u root -ptest123
# - æ‰§è¡Œæµ‹è¯•: pytest tests/integration/
# - ç»“æœåé¦ˆ: æµ‹è¯•é€šè¿‡/å¤±è´¥ â†’ é€€å‡ºç 
```

**Redis ç¼“å­˜æœåŠ¡**:
```yaml
services:
  - name: redis:7-alpine
    alias: redis

# Build Container ä¸­:
# - ç­‰å¾… Redis å¯åŠ¨ï¼ˆçº¦ 2sï¼‰
# - è¿æ¥: redis-cli -h redis ping â†’ PONG
# - è¿è¡Œæµ‹è¯•: npm test
# - ç»“æœåé¦ˆ: æµ‹è¯•æ—¥å¿— â†’ CI æŠ¥å‘Š
```

**Selenium UI æµ‹è¯•**:
```yaml
services:
  - name: selenium/standalone-chrome:latest
    alias: selenium

# Build Container ä¸­:
# - ç­‰å¾… Selenium å¯åŠ¨ï¼ˆçº¦ 10sï¼‰
# - è¿æ¥: WebDriver(command_executor='http://selenium:4444')
# - æ‰§è¡Œ UI æµ‹è¯•
# - ç»“æœåé¦ˆ: æˆªå›¾ + æµ‹è¯•æŠ¥å‘Š â†’ Artifacts
```

---

## äºŒã€å®¹å™¨é—´äº¤äº’æµç¨‹

### é˜¶æ®µ 1ï¼šä»»åŠ¡æ¥æ”¶ä¸ Pod åˆ›å»º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitLab Server      â”‚
â”‚  (gitlab.example.com)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ â‘  æ¨é€ä»£ç è§¦å‘ Pipeline
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Runner Manager Pod  â”‚
â”‚ (è½®è¯¢ä»»åŠ¡)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ â‘¡ è·å–åˆ° build-job ä»»åŠ¡
           â†“
    åˆ›å»º Job Pod
```

### é˜¶æ®µ 2ï¼šJob Pod å†…éƒ¨å®¹å™¨å¯åŠ¨é¡ºåº

```
Job Pod åˆ›å»º
    â”‚
    â”œâ”€â†’ â‘¢ Helper Container (init)
    â”‚      - å…‹éš†ä»£ç åˆ° /builds/
    â”‚      - ä¸‹è½½ artifacts
    â”‚      - å®Œæˆåè¿›å…¥ç­‰å¾…
    â”‚
    â”œâ”€â†’ â‘£ Service Container (DinD)
    â”‚      - å¯åŠ¨ dockerd å®ˆæŠ¤è¿›ç¨‹
    â”‚      - ç›‘å¬ tcp://0.0.0.0:2375
    â”‚
    â””â”€â†’ â‘¤ Build Container
           - ç­‰å¾… DinD å¯åŠ¨ (before_script)
           - æ‰§è¡Œ docker build
           - æ‰§è¡Œ docker push
```

### é˜¶æ®µ 3ï¼šBuild é˜¶æ®µçš„ç½‘ç»œäº¤äº’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Job Pod                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Build Containerâ”‚   â”‚ DinD Container â”‚ â”‚
â”‚  â”‚  (docker CLI)  â”‚   â”‚   (dockerd)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                    â”‚         â”‚
â”‚           â”‚ â‘¥ DOCKER_HOST=     â”‚         â”‚
â”‚           â”‚   tcp://docker:2375â”‚         â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                    â”‚                     â”‚
â”‚                    â”‚ â‘¦ dockerd æ‹‰å–é•œåƒ   â”‚
â”‚                    â”‚   éœ€è¦ DNS è§£æ      â”‚
â”‚                    â†“                     â”‚
â”‚           DNS: 10.255.9.2                â”‚
â”‚                (èŠ‚ç‚¹å†…ç½‘ DNS)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â‘§ æ‹‰å– Python åŸºç¡€é•œåƒ
   swr.cn-north-4.myhuaweicloud.com
```

### é˜¶æ®µ 4ï¼šæ„å»ºäº§ç‰©ä¸Šä¼ 

```
Build Container
    â”‚ â‘¨ docker push å®Œæˆ
    â†“
Helper Container (é‡æ–°æ¿€æ´»)
    â”‚ â‘© ä¸Šä¼  artifacts (å¦‚æœæœ‰)
    â”‚ â‘ª ä¸Šä¼  cache (å¦‚æœæœ‰)
    â†“
GitLab Server
    â”‚ â‘« å­˜å‚¨æ„å»ºäº§ç‰©
    â”‚ â‘¬ æ›´æ–° Pipeline çŠ¶æ€
```

---

## ä¸‰ã€å…³é”®é…ç½®è¯´æ˜

### 3.1 DNS é…ç½®ï¼ˆè§£å†³ DinD æ— æ³•è§£æåŸŸåçš„é—®é¢˜ï¼‰

**é—®é¢˜**:
- é»˜è®¤ Job Pod ä½¿ç”¨ kube-dns (10.96.0.10)
- kube-dns æ— æ³•è§£æå¤–éƒ¨åŸŸå `registry.example.com`
- å¯¼è‡´ `docker build` æ—¶æ‹‰å–åŸºç¡€é•œåƒå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
åœ¨ `gitlab-runner-values.yaml` ä¸­é…ç½®ä½¿ç”¨è‡ªå®šä¹‰ DNSï¼š

```toml
dns_policy = "none"
[runners.kubernetes.dns_config]
  nameservers = ["10.0.0.2", "10.1.0.251", "10.1.0.252"]
  searches = ["gitlab.svc.cluster.local", "svc.cluster.local", "cluster.local"]
  [[runners.kubernetes.dns_config.options]]
    name = "ndots"
    value = "2"
```

**æ•ˆæœ**:
- Job Pod å†…æ‰€æœ‰å®¹å™¨ï¼ˆBuildã€Helperã€Serviceï¼‰éƒ½ä½¿ç”¨è‡ªå®šä¹‰ DNS
- DinD å†…éƒ¨çš„ dockerd å¯ä»¥æ­£ç¡®è§£æé•œåƒä»“åº“åŸŸå

### 3.2 Service Aliasï¼ˆå®¹å™¨é—´é€šä¿¡ï¼‰

**é…ç½®**:
```yaml
services:
  - name: registry.example.com/docker:dind
    alias: docker  # å®šä¹‰åˆ«å
```

**ä½œç”¨**:
- Kubernetes åœ¨ Pod çš„ `/etc/hosts` ä¸­æ·»åŠ ï¼š`127.0.0.1 docker`
- Build Container å¯ä»¥é€šè¿‡ `docker` ä¸»æœºåè®¿é—® DinD
- é…åˆ `DOCKER_HOST=tcp://docker:2375` ä½¿ç”¨

**å¦‚æœæ²¡æœ‰ alias**:
- ä¸»æœºåä¼šæ˜¯å®Œæ•´é•œåƒè·¯å¾„ï¼š`registry.example.com-docker`
- å¯¼è‡´ DNS è§£æå¤±è´¥

### 3.3 DinD ç‰¹æƒæ¨¡å¼

**é…ç½®**:
```yaml
privileged = true  # Runner é…ç½®ä¸­å¯ç”¨
```

**åŸå› **:
- DinD éœ€è¦è®¿é—®å†…æ ¸åŠŸèƒ½ï¼ˆå¦‚ cgroupsã€namespacesï¼‰
- éœ€è¦æŒ‚è½½ `/sys/fs/cgroup` ç­‰ç³»ç»Ÿç›®å½•
- éœ€è¦åˆ›å»ºå’Œç®¡ç†å®¹å™¨

**å®‰å…¨æ³¨æ„**:
- ç‰¹æƒå®¹å™¨å¯ä»¥è®¿é—®å®¿ä¸»æœºå†…æ ¸
- ä»…åœ¨å¯ä¿¡ç¯å¢ƒä¸­ä½¿ç”¨
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Kaniko æˆ– Buildah æ›¿ä»£ DinD

---

## å››ã€èµ„æºé…é¢ä¸å¹¶å‘æ§åˆ¶

### 4.1 Runner Manager çº§åˆ«

```yaml
# 3 ä¸ª Manager Podï¼Œæ¯ä¸ªæœ€å¤š 10 å¹¶å‘
replicas: 3
concurrent: 10

# æ€»å¹¶å‘èƒ½åŠ› = 3 Ã— 10 = 30 ä¸ª job
```

### 4.2 Job Pod èµ„æºé…é¢

```toml
# Build Container
cpu_limit = "2"
memory_limit = "2Gi"

# Service Container (DinD)
service_cpu_limit = "2"
service_memory_limit = "2Gi"

# Helper Container
helper_cpu_limit = "500m"
helper_memory_limit = "512Mi"
```

**å•ä¸ª Job Pod æ€»èµ„æºéœ€æ±‚**:
- CPU: 2 (build) + 2 (dind) + 0.5 (helper) = **4.5 æ ¸**
- å†…å­˜: 2Gi + 2Gi + 0.5Gi = **4.5Gi**

---

## äº”ã€æ•…éšœæ’æŸ¥å‘½ä»¤

### æŸ¥çœ‹ Runner Manager æ—¥å¿—
```bash
kubectl logs -n gitlab -l app=gitlab-runner -f
```

### æŸ¥çœ‹ Job Pod çŠ¶æ€
```bash
kubectl get pods -n gitlab | grep runner-.*concurrent
```

### æŸ¥çœ‹ Job Pod å„å®¹å™¨æ—¥å¿—
```bash
# Build Container
kubectl logs -n gitlab <pod-name> -c build

# Helper Container
kubectl logs -n gitlab <pod-name> -c helper

# Service Container (DinD)
kubectl logs -n gitlab <pod-name> -c docker
```

### æ£€æŸ¥ DNS é…ç½®
```bash
kubectl exec -n gitlab <pod-name> -c build -- cat /etc/resolv.conf
```

### æµ‹è¯• DinD è¿æ¥
```bash
kubectl exec -n gitlab <pod-name> -c build -- docker -H tcp://docker:2375 info
```

---

## å…­ã€æ€»ç»“

| å®¹å™¨ç±»å‹ | é•œåƒ | è¿è¡Œæ—¶é•¿ | ä¸»è¦èŒè´£ |
|---------|------|---------|---------|
| **Runner Manager** | gitlab-runner:v18.3.0 | æŒç»­è¿è¡Œ | ä»»åŠ¡è°ƒåº¦ã€Pod åˆ›å»º |
| **Helper** | runner-helper:v18.3.0 | Job æœŸé—´ | ä»£ç å…‹éš†ã€äº§ç‰©ä¸Šä¼  |
| **Build** | ç”¨æˆ·æŒ‡å®š (å¦‚ docker:latest) | Job æœŸé—´ | æ‰§è¡Œ CI/CD è„šæœ¬ |
| **Service** | ç”¨æˆ·æŒ‡å®š (å¦‚ dind) | Job æœŸé—´ | æä¾›è¾…åŠ©æœåŠ¡ |

**å…³é”®äº¤äº’**:
1. Manager è½®è¯¢ GitLab â†’ åˆ›å»º Job Pod
2. Helper å…‹éš†ä»£ç  â†’ Build å¼€å§‹æ‰§è¡Œ
3. Build é€šè¿‡ alias è®¿é—® Service (DinD)
4. Build å®Œæˆ â†’ Helper ä¸Šä¼ äº§ç‰© â†’ å‘ GitLab æ±‡æŠ¥
5. Job Pod é”€æ¯ â†’ Manager ç»§ç»­è½®è¯¢ä¸‹ä¸€ä¸ªä»»åŠ¡

**ç½‘ç»œè¦ç‚¹**:
- Job Pod å†…æ‰€æœ‰å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´
- é€šè¿‡ DNS é…ç½®ç¡®ä¿ DinD èƒ½è®¿é—®é•œåƒä»“åº“
- Service alias ç®€åŒ–å®¹å™¨é—´é€šä¿¡
